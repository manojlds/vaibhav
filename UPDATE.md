# Updating vaibhav

The `vaibhav update` command keeps both your phone and desktop in sync with the latest version.

## Quick update

**Phone (Termux):**

```bash
vaibhav update
```

This does three things:
1. Downloads latest `bin/vaibhav` and `bin/vaibhav-ralph` from the latest GitHub Release
2. Verifies SHA256 checksums before replacing files
3. SSHes to your desktop and runs `git pull` to update there too

**Desktop:**

```bash
vaibhav update
```

Runs `git pull` in the vaibhav repo (since the desktop script is symlinked to the repo).

---

## What happens on each platform

### Termux (phone) update flow

```
vaibhav update
  │
  ├─ Download latest `vaibhav` release asset
  ├─ Read embedded version from downloaded script
  ├─ Compare remote version to installed version
  │
  ├─ Same version?
  │   └─ "Already up to date (v0.3.0)" → done
  │
  ├─ Download release assets (vaibhav, vaibhav-ralph, checksums.sha256)
  ├─ Verify SHA256 checksums of downloaded files
  │   ├─ Mismatch? → abort, keep old files
  │   └─ Match? → continue
  │
  ├─ Atomic update: move verified files into ~/bin/
  ├─ "✓ Updated: v0.2.0 → v0.3.0"
  │
  └─ SSH to desktop → git pull origin main
      ├─ "✓ Desktop updated: v0.2.0 → v0.3.0"
      ├─ "✓ Desktop already up to date"
      └─ (warns and continues if SSH fails)
```

### Desktop update flow

```
vaibhav update
  │
  ├─ Resolve repo path from ~/bin/vaibhav symlink
  ├─ Check for uncommitted changes
  │   └─ Changes found? → abort with warning
  │
  ├─ git pull
  │   ├─ "Already up to date (v0.3.0)"
  │   └─ "✓ Updated: v0.2.0 → v0.3.0"
```

---

## Options

```bash
vaibhav update            # Update phone + desktop
vaibhav update --local    # Update phone only, skip desktop
```

---

## Checksum verification

Every Termux update verifies file integrity using SHA256 checksums. The `checksums.sha256` file is generated by CI during the release process and attached as a release asset — it is not committed to the repo.

If any downloaded file doesn't match its checksum, the update aborts and your existing files are untouched.

### Releasing a new version (for maintainers)

To release, bump `VAIBHAV_VERSION` in `bin/vaibhav`, commit, tag, and push:

```bash
git tag v0.4.0
git push origin v0.4.0
```

The GitHub Actions workflow generates checksums, creates a release, and uploads all assets automatically.

---

## Version checking

```bash
vaibhav --version         # Show installed version
```

The version is embedded in `bin/vaibhav` as `VAIBHAV_VERSION`. The update command shows the version change:

```
✓ Updated: v0.2.0 → v0.3.0
```

---

## Safety guarantees

- **Atomic updates** — files are downloaded to a temp directory, verified, then moved into place. A failed download never leaves you with a broken install.
- **Checksum verification** — corrupted or incomplete downloads are caught before replacing files.
- **No force-pull** — desktop update aborts if there are local uncommitted changes.
- **Desktop failure is non-fatal** — if SSH to desktop fails during a phone update, the local update still succeeds with a warning.
- **Idempotent** — running `vaibhav update` when already up to date is a no-op.

---

## Setup scripts are also idempotent

Both setup scripts can be safely re-run to repair or upgrade an installation:

**Termux:**

```bash
bash setup-termux.sh
```

- Skips SSH key generation if key exists
- Detects existing SSH config block — replaces if changed, skips if identical
- Uses existing config values as defaults (no need to re-enter hostname/username)
- Doesn't overwrite custom `termux.properties` settings beyond the extra-keys block

**Desktop:**

```bash
./setup-desktop.sh
```

- Doesn't duplicate PATH entries in shell rc files
- Skips mosh prompt if already installed
- Only runs `vaibhav init` if config doesn't exist (offers re-configure otherwise)
- SSH server install/start skipped if already running

---

## Troubleshooting

**"Checksum verification failed"** — The downloaded file doesn't match the expected hash. This usually means GitHub's CDN served a stale version. Wait a minute and try again.

**"Desktop has local changes"** — Your desktop repo has uncommitted changes. Commit or stash them first: `cd ~/projects/vaibhav && git stash && vaibhav update`.

**"Could not connect to desktop via SSH"** — Make sure Tailscale is running on both devices and SSH is configured. Use `vaibhav update --local` to skip the desktop update.
